#!/usr/bin/env python3
# bloodhound_exploit.py - Modern Passive BloodHound Analyzer
# USAGE: python3 bloodhound_exploit.py *.json
#        (Use * to automatically include every JSON file in the folder)
# DESCRIPTION: Scans SharpHound output for paths without needing Neo4j.

import json
import sys
import os

def analyze_bloodhound(files):
    print("[*] Passive BloodHound Triage Started...")
    print("[*] Scanning for high-value AD attack paths...")
    print("-" * 50)

    for file in files:
        if not os.path.exists(file):
            continue
            
        try:
            with open(file, 'r', encoding='utf-8-sig') as f:
                data = json.load(f)
        except Exception as e:
            print(f"[!] Error reading {file}: {e}")
            continue

        # Sharphound usually creates a list of nodes in a 'data' or 'members' key
        nodes = data.get('data', [])
        if not nodes:
            nodes = data.get('members', []) # Compatibility for different versions

        for node in nodes:
            props = node.get('Properties', node.get('properties', {}))
            name = props.get('name', props.get('Name', 'Unknown'))
            
            # --- 1. SENSITIVE PRIVILEGES ---
            if props.get('unconstraineddelegation'):
                print(f"[!] CONTEXT: {name} has UNCONSTRAINED DELEGATION")
                print(f"    [+] Exploit: Coerce auth (PrinterBug/PetitPotam) and catch TGT with Rubeus monitor.")

            # --- 2. ADVANCED AD PATHS (OCD STYLE) ---
            # ESC1 Discovery (Supplies Subject)
            if props.get('enrollmentrights') and (props.get('enrolleesuppliessubject') or "ESC1" in str(node)):
                print(f"[!] VULNERABILITY: Potential AD CS ESC1 on {name}")
                print(f"    [+] Command: certipy req -u user@domain -p pass -ca [CA] -template {name} -upn administrator@domain")

            # RBCD (Resource-Based Constrained Delegation)
            if props.get('allowedtoact'):
                print(f"[!] VULNERABILITY: Resource-Based Constrained Delegation (RBCD) on {name}")
                print(f"    [+] Exploit: addcomputer -> rbcd -action write -> getST -impersonate Administrator")

            # Shadow Credentials (msDS-KeyCredentialLink)
            # In BH v4, this is usually an edge, but some collectors flag the property
            if props.get('has-keycredentiallink'):
                 print(f"[!] VULNERABILITY: Shadow Credentials possible on {name}")
                 print(f"    [+] Command: certipy shadow auto -account {name} ...")

            # --- 3. STANDARD ACL ABUSE ---
            # Parsing "Aces" or "Relationships" (Internal BH v4 format)
            aces = node.get('Aces', [])
            for ace in aces:
                right = ace.get('RightName', '')
                principal = ace.get('PrincipalName', 'Unknown')
                
                if right in ['GenericAll', 'GenericWrite', 'WriteDacl', 'WriteOwner', 'AllExtendedRights']:
                    print(f"[!] ACL ABUSE: {principal} has {right} over {name}")
                    
                    if right == 'GenericAll':
                        print(f"    [+] Action: Reset password: net rpc password {name} ...")
                    elif right == 'GenericWrite':
                        print(f"    [+] Action: Shadow Creds (if User) or RBCD (if Computer)")
                    elif right == 'WriteDacl':
                        print(f"    [+] Action: Add DCSync rights via bloodyAD")
                    elif right == 'AllExtendedRights':
                         print(f"    [+] Action: ForceChangePassword possible via rpcclient")

            # --- 4. GPO ABUSE ---
            if node.get('type') == 'GPO' or 'GPO' in name.upper():
                print(f"[*] GPO FOUND: {name}")
                print(f"    [+] Check 'Aces' for GenericAll/Write to exploit via SharpGPOAbuse.")

    print("-" * 50)
    print("[*] Triage complete. Cross-reference with Decision_Matrix.md.")

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: python3 bloodhound_exploit.py <SharpHound_JSON_files>")
        print("Example: python3 bloodhound_exploit.py *users.json *computers.json")
        sys.exit(1)
    
    analyze_bloodhound(sys.argv[1:])
