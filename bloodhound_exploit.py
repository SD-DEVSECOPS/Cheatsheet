#!/usr/bin/env python3
# bloodhound_exploit.py - Parse BloodHound and suggest exploits
# USAGE: python3 bloodhound_exploit.py <bloodhound_json_files>

import json
import sys
import os

def analyze_bloodhound(files):
    """Analyze BloodHound JSON files and suggest exploits"""
    
    print("[*] Analyzing BloodHound data...")
    
    for file in files:
        with open(file, 'r') as f:
            data = json.load(f)
            
            # Check for owned users
            for node in data.get('data', []):
                if node.get('type') == 'User' and node.get('properties', {}).get('owned'):
                    user = node['properties']['name']
                    print(f"[!] OWNED USER: {user}")
                    
                    # Check group memberships
                    for edge in data.get('data', []):
                        if edge.get('type') == 'MemberOf' and edge.get('start') == node['id']:
                            group_id = edge['end']
                            for group_node in data['data']:
                                if group_node['id'] == group_id:
                                    group = group_node['properties']['name']
                                    if 'admin' in group.lower():
                                        print(f"[+] User is in privileged group: {group}")
                                        print("[+] Try: DCSync, Golden Ticket, etc.")
                    
                # Check for GenericAll, WriteDACL, WriteOwner
                if node.get('type') == 'User' or node.get('type') == 'Group' or node.get('type') == 'Computer':
                    for edge in data.get('data', []):
                        if edge.get('type') in ['GenericAll', 'WriteDacl', 'WriteOwner'] and edge.get('target') == node['id']:
                            print(f"[!] ACL ABUSE POSSIBLE on {node['properties']['name']}")
                            print(f"[+] Edge: {edge['type']} from {edge.get('source', 'Unknown')}")
                            if edge['type'] == 'GenericAll':
                                print("[+] Exploit: Reset password, add to groups")
                            elif edge['type'] == 'WriteDacl':
                                print("[+] Exploit: Give yourself DCSync rights")
                            elif edge['type'] == 'WriteOwner':
                                print("[+] Exploit: Take ownership then modify")
                
                # Check for Unconstrained Delegation
                if node.get('type') == 'Computer' and node.get('properties', {}).get('unconstraineddelegation'):
                    print(f"[!] UNCONSTRAINED DELEGATION: {node['properties']['name']}")
                    print("[+] Exploit: Monitor for DA tokens, dump with Rubeus")
                
                # Check for Constrained Delegation
                if node.get('properties', {}).get('allowedtodelegate'):
                    targets = node['properties']['allowedtodelegate']
                    print(f"[!] CONSTRAINED DELEGATION: {node['properties']['name']}")
                    print(f"[+] Can delegate to: {targets}")
                    print("[+] Exploit: Use Rubeus s4u with protocol transition")

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: python3 bloodhound_exploit.py <bloodhound_json_files>")
        sys.exit(1)
    
    analyze_bloodhound(sys.argv[1:])
